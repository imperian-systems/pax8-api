# Quickstart: Quotes API

**Generated by**: `/speckit.plan` Phase 1

## Overview

This guide demonstrates how to use the Quotes API to create and manage sales proposals/quotes.

---

## Prerequisites

```typescript
import { Pax8Client } from 'pax8-api';

const client = new Pax8Client({
  clientId: process.env.PAX8_CLIENT_ID!,
  clientSecret: process.env.PAX8_CLIENT_SECRET!,
});
```

---

## Quote Lifecycle

### Create a Quote

```typescript
// Create a new quote for a client
const quote = await client.quotes.create({
  clientId: '12345678-1234-1234-1234-123456789012',
});

console.log(`Created quote: ${quote.id}`);
console.log(`Reference code: ${quote.referenceCode}`);
console.log(`Status: ${quote.status}`);  // 'draft'
```

### List Quotes

```typescript
// List quotes with pagination (v2 uses limit/page, 1-indexed)
const quotes = await client.quotes.list({
  limit: 20,
  page: 1,
  sort: 'createdOn,desc',
});

console.log(`Found ${quotes.page.totalElements} quotes`);
console.log(`Status counts:`, quotes.statusCounts);

for (const quote of quotes.content) {
  console.log(`${quote.referenceCode} - ${quote.status}`);
}
```

### Filter by Status

```typescript
// Get only draft quotes
const draftQuotes = await client.quotes.list({
  status: 'draft',
  account: 'user',  // 'user' or 'partner' scope
});

console.log(`Found ${draftQuotes.page.totalElements} draft quotes`);
```

### Get a Single Quote

```typescript
const quoteId = '87654321-4321-4321-4321-210987654321';
const quote = await client.quotes.get(quoteId);

console.log(`Quote: ${quote.referenceCode}`);
console.log(`Status: ${quote.status}`);
console.log(`Client: ${quote.client.name}`);
console.log(`Line items: ${quote.lineItems.length}`);
console.log(`Total: ${quote.totals.recurringTotal.amount} ${quote.totals.recurringTotal.currency}`);
```

### Update a Quote

```typescript
const updated = await client.quotes.update(quoteId, {
  introMessage: 'Thank you for considering our services.',
  termsAndDisclaimers: 'Standard terms apply.',
  status: 'sent',
  published: true,
});

console.log(`Quote status: ${updated.status}`);
console.log(`Published: ${updated.published}`);
```

### Delete a Quote

```typescript
await client.quotes.delete(quoteId);
console.log('Quote deleted');
```

---

## Line Item Management

### Add Standard Product Line Items

```typescript
// Add a standard product line item
const quote = await client.quotes.addLineItems(quoteId, [
  {
    type: 'Standard',
    productId: 'product-uuid-here',
    billingTerm: 'Monthly',
    quantity: 5,
    price: { amount: 12.99, currency: 'USD' },
  },
]);

console.log(`Quote now has ${quote.lineItems.length} line items`);
```

### Add Custom Line Items

```typescript
// Add a custom line item (not linked to a product)
const quote = await client.quotes.addLineItems(quoteId, [
  {
    type: 'Custom',
    productName: 'Implementation Services',
    productSku: 'IMPL-001',
    billingTerm: 'One-Time',
    quantity: 1,
    cost: { amount: 500, currency: 'USD' },
    price: { amount: 750, currency: 'USD' },
    note: 'Initial setup and configuration',
  },
]);
```

### Add Usage-Based Line Items

```typescript
// Add a usage-based line item
const quote = await client.quotes.addLineItems(quoteId, [
  {
    type: 'UsageBased',
    productId: 'usage-product-uuid',
    billingTerm: 'Monthly',
    cost: { amount: 0.05, currency: 'USD' },
    usageBased: {
      type: 'QTY_VARIES',
      displayNote: true,
    },
  },
]);
```

### Add Multiple Line Items at Once

```typescript
// Add multiple line items in a single request
const quote = await client.quotes.addLineItems(quoteId, [
  {
    type: 'Standard',
    productId: 'product-1-uuid',
    billingTerm: 'Annual',
    quantity: 10,
  },
  {
    type: 'Standard',
    productId: 'product-2-uuid',
    billingTerm: 'Annual',
    quantity: 10,
  },
  {
    type: 'Custom',
    productName: 'Setup Fee',
    billingTerm: 'One-Time',
    cost: { amount: 100, currency: 'USD' },
    price: { amount: 150, currency: 'USD' },
  },
]);
```

### Update Line Items

```typescript
// Update existing line items
const quote = await client.quotes.updateLineItems(quoteId, [
  {
    id: 'line-item-uuid',
    quantity: 15,
    price: { amount: 11.99, currency: 'USD' },
    note: 'Updated pricing',
  },
]);
```

### Delete a Single Line Item

```typescript
await client.quotes.deleteLineItem(quoteId, 'line-item-uuid');
console.log('Line item deleted');
```

### Bulk Delete Line Items

```typescript
await client.quotes.bulkDeleteLineItems(quoteId, {
  lineItemIds: ['line-item-1', 'line-item-2', 'line-item-3'],
});
console.log('Line items deleted');
```

---

## Section Management

### Get Sections

```typescript
const sections = await client.quotes.getSections(quoteId);

for (const section of sections) {
  console.log(`Section: ${section.name} (order: ${section.order})`);
  console.log(`  Line items: ${section.lineItems.length}`);
}
```

### Create a Section

```typescript
const sections = await client.quotes.createSection(quoteId, {
  name: 'Core Services',
});

console.log(`Created section: ${sections[sections.length - 1].name}`);
```

### Update Sections

```typescript
// Reorder and rename sections
const sections = await client.quotes.updateSections(quoteId, {
  sections: [
    {
      id: 'section-1-uuid',
      name: 'Primary Services',
      order: 1,
      lineItems: [
        { lineItemId: 'line-item-1', order: 1 },
        { lineItemId: 'line-item-2', order: 2 },
      ],
    },
    {
      id: 'section-2-uuid',
      name: 'Add-ons',
      order: 2,
    },
  ],
});
```

---

## Access List (Sharing)

### Get Access List

```typescript
const accessList = await client.quotes.getAccessList(quoteId);

for (const entry of accessList) {
  console.log(`${entry.email}: ${entry.link}`);
}
```

### Share Quote with Recipients

```typescript
// Add email recipients to the access list
const accessList = await client.quotes.addAccessListEntries(quoteId, {
  emails: [
    'customer@example.com',
    'decision-maker@example.com',
  ],
});

for (const entry of accessList) {
  console.log(`Shared with ${entry.email}`);
  console.log(`  Access link: ${entry.link}`);
}
```

### Remove Access

```typescript
await client.quotes.deleteAccessListEntry(quoteId, 'access-entry-uuid');
console.log('Access removed');
```

---

## Quote Preferences

### Get Current Preferences

```typescript
const preferences = await client.quotePreferences.get();

console.log(`Days to expire: ${preferences.daysToExpire}`);
console.log(`Default intro: ${preferences.introMessage}`);
console.log(`Default terms: ${preferences.termsAndDisclaimers}`);
```

### Update Preferences

```typescript
const preferences = await client.quotePreferences.update({
  daysToExpire: 30,
  introMessage: 'Thank you for your interest in our services.',
  termsAndDisclaimers: 'All prices are valid for 30 days from quote date.',
});
```

---

## Complete Example: Create and Send a Quote

```typescript
import { Pax8Client } from 'pax8-api';

async function createAndSendQuote(clientId: string, products: Array<{ id: string; qty: number }>) {
  const client = new Pax8Client({
    clientId: process.env.PAX8_CLIENT_ID!,
    clientSecret: process.env.PAX8_CLIENT_SECRET!,
  });

  // 1. Create the quote
  let quote = await client.quotes.create({ clientId });
  console.log(`Created quote: ${quote.referenceCode}`);

  // 2. Add line items
  quote = await client.quotes.addLineItems(
    quote.id,
    products.map((p) => ({
      type: 'Standard' as const,
      productId: p.id,
      billingTerm: 'Monthly' as const,
      quantity: p.qty,
    })),
  );
  console.log(`Added ${quote.lineItems.length} line items`);

  // 3. Organize into sections
  await client.quotes.createSection(quote.id, { name: 'Proposed Services' });

  // 4. Update quote details and publish
  quote = await client.quotes.update(quote.id, {
    introMessage: 'Please review our proposal for your technology needs.',
    termsAndDisclaimers: 'Prices valid for 30 days.',
    published: true,
    status: 'sent',
  });

  // 5. Share with customer
  const accessList = await client.quotes.addAccessListEntries(quote.id, {
    emails: ['customer@example.com'],
  });

  console.log(`\n=== Quote Ready ===`);
  console.log(`Reference: ${quote.referenceCode}`);
  console.log(`Status: ${quote.status}`);
  console.log(`Total: ${quote.totals.recurringTotal.amount} ${quote.totals.recurringTotal.currency}`);
  console.log(`Customer link: ${accessList[0].link}`);

  return quote;
}

// Usage
createAndSendQuote('client-uuid', [
  { id: 'product-1', qty: 5 },
  { id: 'product-2', qty: 10 },
]);
```

---

## Error Handling

```typescript
import { Pax8Error } from 'pax8-api';

try {
  await client.quotes.get('invalid-quote-id');
} catch (error) {
  if (error instanceof Pax8Error) {
    console.error(`Error: ${error.message}`);
    console.error(`Type: ${error.type}`);  // e.g., 'QUOTE_NOT_FOUND'
    console.error(`Status: ${error.status}`);
    
    if (error.details) {
      for (const detail of error.details) {
        console.error(`  ${detail.field}: ${detail.message}`);
      }
    }
  }
}
```

### Common Error Types

| Error Type | Description |
|------------|-------------|
| `QUOTE_NOT_FOUND` | Quote ID does not exist |
| `QUOTE_VALIDATION` | Invalid status transition or validation failure |
| `LINE_ITEM_LIMIT_EXCEEDED` | Quote has maximum 30 line items |
| `QUOTE_ACCESS_EMAIL_EXISTS` | Email already in access list |
| `ACCESS_DENIED` | Insufficient permissions |
| `PAYLOAD_VALIDATION` | Request body validation failed |

---

## Pagination Differences (v2 vs v1)

The Quotes API uses v2 pagination which differs from v1 APIs:

| Feature | v1 APIs | v2 Quotes API |
|---------|---------|---------------|
| Items per page | `size` | `limit` |
| Page number | `page` (0-indexed) | `page` (1-indexed) |
| Default page | 0 | 1 |
| Max per page | 200 | 50 |

```typescript
// v1 API example (Companies, Invoices, etc.)
const companies = await client.companies.list({ page: 0, size: 100 });

// v2 API example (Quotes)
const quotes = await client.quotes.list({ page: 1, limit: 50 });
```

---

## Type Safety with Line Items

The discriminated union for line item types provides compile-time safety:

```typescript
import type { AddLineItemPayload } from 'pax8-api';

function processLineItem(payload: AddLineItemPayload) {
  switch (payload.type) {
    case 'Standard':
      // TypeScript knows payload has productId
      console.log(`Product: ${payload.productId}`);
      break;
    case 'Custom':
      // TypeScript knows payload has productName, cost, price
      console.log(`Custom: ${payload.productName}`);
      console.log(`Margin: ${payload.price.amount - payload.cost.amount}`);
      break;
    case 'UsageBased':
      // TypeScript knows payload has usageBased config
      console.log(`Usage type: ${payload.usageBased.type}`);
      break;
  }
}
```
