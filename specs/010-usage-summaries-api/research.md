# Research: Usage Summaries API

**Generated by**: `/speckit.plan` Phase 0

## Overview

This document resolves all NEEDS CLARIFICATION items from the Technical Context and documents research findings for technical decisions.

---

## Research Topics

### 1. UsageSummary Schema (Pax8 Official API)

**Question**: What is the exact schema for UsageSummary from the Pax8 Partner API?

**Decision**: Use the official Pax8 Partner API OpenAPI schema.

**Findings**: From `https://devx.pax8.com/openapi/6463f53f2c9755000aaf50be`:

```typescript
interface UsageSummary {
  id: string;                    // UUID
  companyId: string;             // UUID
  productId: string;             // UUID
  resourceGroup: string;         // e.g., "Office 365 E3"
  vendorName: string;            // e.g., "Microsoft"
  currentCharges: number;        // decimal
  currencyCode: string;          // ISO 4217, e.g., "USD"
  partnerTotal: number;          // decimal
  isTrial: boolean;              // NOT status field
}
```

**Rationale**: Official OpenAPI is the authoritative source per constitution. The `isTrial` boolean replaces any assumed "status" field.

**Alternatives Considered**: None - official API is definitive.

---

### 2. UsageLine Schema (Pax8 Official API)

**Question**: What is the exact schema for UsageLine?

**Decision**: Use the official Pax8 Partner API OpenAPI schema.

**Findings**: From official OpenAPI:

```typescript
interface UsageLine {
  usageSummaryId: string;        // UUID
  usageDate: string;             // ISO 8601 date
  productName: string;
  productId: string;             // UUID
  unitOfMeasure: string;
  quantity: number;              // decimal
  currentCharges: number;        // decimal
  currentProfit: number;         // decimal
  partnerTotal: number;          // decimal
  unitPrice: number;             // decimal
  currencyCode: string;          // ISO 4217
  isTrial: boolean;
}
```

**Rationale**: Official OpenAPI is authoritative. Note `usageDate` is required for fetching lines.

**Alternatives Considered**: None - official API is definitive.

---

### 3. API Endpoint Structure

**Question**: How should the client API methods be structured?

**Decision**: Mirror Pax8 API structure (Option B from clarification).

**Findings**:
- `GET /subscriptions/{subscriptionId}/usage-summaries` → `subscriptions.listUsageSummaries(subscriptionId, options)`
- `GET /usage-summaries/{usageSummaryId}` → `usageSummaries.get(usageSummaryId)`
- `GET /usage-summaries/{usageSummaryId}/usage-lines` → `usageSummaries.listLines(usageSummaryId, options)` (requires `usageDate`)

**Rationale**: 
1. Mirrors Pax8 API paths for developer familiarity
2. Consistent with how other APIs organize nested resources
3. User explicitly chose Option B in clarification

**Alternatives Considered**:
- Option A (convenience methods): Would duplicate listing on both namespaces, less clear ownership

---

### 4. Pagination Pattern

**Question**: What pagination pattern should be used?

**Decision**: Use existing page-based pagination with `PagedResponse<T>`.

**Findings**: From existing `src/models/invoices.ts` and `src/api/invoices.ts`:
- `ListUsageSummariesOptions` extends base pagination options
- `ListUsageLinesOptions` extends base with required `usageDate`
- Response uses `PagedResponse<T>` with `page`, `size`, `totalPages`, `totalElements`, `content`

**Rationale**: Consistency with existing API methods; Pax8 API uses same pagination structure.

**Alternatives Considered**: None - existing pattern is optimal.

---

### 5. Required Parameters for Usage Lines

**Question**: What parameters are required for listing usage lines?

**Decision**: `usageDate` is required per Pax8 API.

**Findings**: From official OpenAPI, the `/usage-summaries/{usageSummaryId}/usage-lines` endpoint requires:
- Path parameter: `usageSummaryId` (required)
- Query parameter: `usageDate` (required, ISO 8601 date string)

**Rationale**: API returns 400 without usageDate; it's mandatory for the endpoint.

**Alternatives Considered**: Making usageDate optional with default to "today" - rejected because API requires it explicitly.

---

### 6. Error Handling Pattern

**Question**: How should errors be handled?

**Decision**: Use existing `Pax8Error` and HTTP utility patterns.

**Findings**: From `src/errors/pax8-error.ts` and `src/http/api-utils.ts`:
- `Pax8Error` with status, message, requestId
- Retry logic in `src/http/retry.ts` handles 429/5xx
- API utils provide consistent response parsing

**Rationale**: Consistency with existing codebase; no new error patterns needed.

**Alternatives Considered**: None - existing pattern is comprehensive.

---

### 7. Type Assertion Pattern

**Question**: Should type assertion functions be added?

**Decision**: Yes, add `isUsageSummary()`, `assertUsageSummary()`, `isUsageLine()`, `assertUsageLine()`.

**Findings**: From `src/models/invoices.ts`:
```typescript
export function isInvoice(obj: unknown): obj is Invoice { ... }
export function assertInvoice(obj: unknown): asserts obj is Invoice { ... }
```

**Rationale**: Consistency with existing model patterns; enables runtime type safety.

**Alternatives Considered**: None - established pattern.

---

## Summary of Resolved Items

| Item | Resolution |
|------|------------|
| UsageSummary schema | Official Pax8 OpenAPI (no status, uses isTrial) |
| UsageLine schema | Official Pax8 OpenAPI (usageDate required) |
| API structure | Mirror Pax8 structure (subscriptions.listUsageSummaries + usageSummaries.get/listLines) |
| Pagination | Existing PagedResponse pattern |
| usageDate requirement | Required parameter for listLines |
| Error handling | Existing Pax8Error + retry utilities |
| Type assertions | Add is/assert functions per existing pattern |

All NEEDS CLARIFICATION items resolved. Ready for Phase 1.
