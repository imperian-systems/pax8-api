# Quickstart: Usage Summaries API

**Generated by**: `/speckit.plan` Phase 1

## Overview

This guide demonstrates how to use the Usage Summaries API to retrieve usage data for subscriptions.

---

## Prerequisites

```typescript
import { Pax8Client } from 'pax8-api';

const client = new Pax8Client({
  clientId: process.env.PAX8_CLIENT_ID!,
  clientSecret: process.env.PAX8_CLIENT_SECRET!,
});
```

---

## List Usage Summaries for a Subscription

Retrieve usage summaries for a specific subscription:

```typescript
// List usage summaries for a subscription
const subscriptionId = '12345678-1234-1234-1234-123456789012';

const summaries = await client.subscriptions.listUsageSummaries(subscriptionId);

console.log(`Found ${summaries.page.totalElements} usage summaries`);

for (const summary of summaries.content) {
  console.log(`${summary.resourceGroup} (${summary.vendorName})`);
  console.log(`  Charges: ${summary.currentCharges} ${summary.currencyCode}`);
  console.log(`  Partner Total: ${summary.partnerTotal} ${summary.currencyCode}`);
  console.log(`  Trial: ${summary.isTrial}`);
}
```

### With Pagination

```typescript
// Paginate through all usage summaries
const allSummaries = await client.subscriptions.listUsageSummaries(subscriptionId, {
  page: 0,
  size: 50,
  sort: 'resourceGroup,asc',
});

// Get next page
if (allSummaries.page.number < allSummaries.page.totalPages - 1) {
  const nextPage = await client.subscriptions.listUsageSummaries(subscriptionId, {
    page: allSummaries.page.number + 1,
    size: 50,
  });
}
```

---

## Get a Single Usage Summary

Retrieve a specific usage summary by ID:

```typescript
const usageSummaryId = '87654321-4321-4321-4321-210987654321';

const summary = await client.usageSummaries.get(usageSummaryId);

console.log(`Usage Summary: ${summary.id}`);
console.log(`  Company: ${summary.companyId}`);
console.log(`  Product: ${summary.productId}`);
console.log(`  Resource Group: ${summary.resourceGroup}`);
console.log(`  Vendor: ${summary.vendorName}`);
console.log(`  Current Charges: ${summary.currentCharges} ${summary.currencyCode}`);
console.log(`  Partner Total: ${summary.partnerTotal} ${summary.currencyCode}`);
console.log(`  Trial: ${summary.isTrial}`);
```

---

## List Usage Lines for a Summary

Retrieve detailed usage lines for a usage summary. **Note**: `usageDate` is required.

```typescript
const usageSummaryId = '87654321-4321-4321-4321-210987654321';

// usageDate is REQUIRED
const lines = await client.usageSummaries.listLines(usageSummaryId, {
  usageDate: '2024-01-15',
});

console.log(`Found ${lines.page.totalElements} usage lines for 2024-01-15`);

for (const line of lines.content) {
  console.log(`${line.productName}`);
  console.log(`  Date: ${line.usageDate}`);
  console.log(`  Quantity: ${line.quantity} ${line.unitOfMeasure}`);
  console.log(`  Unit Price: ${line.unitPrice} ${line.currencyCode}`);
  console.log(`  Current Charges: ${line.currentCharges} ${line.currencyCode}`);
  console.log(`  Profit: ${line.currentProfit} ${line.currencyCode}`);
  console.log(`  Partner Total: ${line.partnerTotal} ${line.currencyCode}`);
  console.log(`  Trial: ${line.isTrial}`);
}
```

### With Pagination

```typescript
// Paginate through usage lines for a date
const allLines = await client.usageSummaries.listLines(usageSummaryId, {
  usageDate: '2024-01-15',
  page: 0,
  size: 100,
});
```

---

## Complete Example: Monthly Usage Report

```typescript
import { Pax8Client } from 'pax8-api';

async function generateMonthlyUsageReport(subscriptionId: string, month: string) {
  const client = new Pax8Client({
    clientId: process.env.PAX8_CLIENT_ID!,
    clientSecret: process.env.PAX8_CLIENT_SECRET!,
  });

  // Get all usage summaries for the subscription
  const summaries = await client.subscriptions.listUsageSummaries(subscriptionId, {
    size: 200, // Max page size
  });

  console.log(`\n=== Usage Report for ${month} ===\n`);
  console.log(`Subscription: ${subscriptionId}`);
  console.log(`Total Summaries: ${summaries.page.totalElements}\n`);

  let totalCharges = 0;
  let totalPartnerRevenue = 0;

  for (const summary of summaries.content) {
    console.log(`ðŸ“¦ ${summary.resourceGroup} (${summary.vendorName})`);
    console.log(`   Product ID: ${summary.productId}`);
    console.log(`   Charges: $${summary.currentCharges.toFixed(2)} ${summary.currencyCode}`);
    console.log(`   Partner Total: $${summary.partnerTotal.toFixed(2)} ${summary.currencyCode}`);
    
    if (summary.isTrial) {
      console.log(`   âš ï¸ TRIAL`);
    }

    totalCharges += summary.currentCharges;
    totalPartnerRevenue += summary.partnerTotal;

    // Get usage lines for a specific date
    try {
      const lines = await client.usageSummaries.listLines(summary.id, {
        usageDate: `${month}-15`, // Mid-month sample
      });

      if (lines.content.length > 0) {
        console.log(`   ðŸ“‹ Usage Lines (${month}-15):`);
        for (const line of lines.content.slice(0, 3)) {
          console.log(`      - ${line.productName}: ${line.quantity} ${line.unitOfMeasure}`);
        }
        if (lines.content.length > 3) {
          console.log(`      ... and ${lines.content.length - 3} more`);
        }
      }
    } catch (error) {
      // Lines may not be available for all dates
      console.log(`   (No line data for ${month}-15)`);
    }

    console.log('');
  }

  console.log(`=== Summary ===`);
  console.log(`Total Charges: $${totalCharges.toFixed(2)}`);
  console.log(`Total Partner Revenue: $${totalPartnerRevenue.toFixed(2)}`);
  console.log(`Margin: $${(totalCharges - totalPartnerRevenue).toFixed(2)}`);
}

// Usage
generateMonthlyUsageReport(
  '12345678-1234-1234-1234-123456789012',
  '2024-01'
).catch(console.error);
```

---

## Error Handling

```typescript
import { Pax8Client, Pax8Error } from 'pax8-api';

const client = new Pax8Client({
  clientId: process.env.PAX8_CLIENT_ID!,
  clientSecret: process.env.PAX8_CLIENT_SECRET!,
});

try {
  const summary = await client.usageSummaries.get('invalid-id');
} catch (error) {
  if (error instanceof Pax8Error) {
    console.error(`Pax8 API Error: ${error.message}`);
    console.error(`Status: ${error.status}`);
    console.error(`Request ID: ${error.requestId}`);
  } else {
    throw error;
  }
}

// Missing required usageDate
try {
  // @ts-expect-error - usageDate is required
  const lines = await client.usageSummaries.listLines('some-id', {});
} catch (error) {
  // TypeScript will catch this at compile time
  // Runtime will return 400 Bad Request
}
```

---

## Type Guards

```typescript
import { 
  UsageSummary, 
  UsageLine, 
  isUsageSummary, 
  assertUsageSummary,
  isUsageLine,
  assertUsageLine 
} from 'pax8-api';

// Type guard
const data: unknown = await fetchSomeData();

if (isUsageSummary(data)) {
  // data is now typed as UsageSummary
  console.log(data.resourceGroup);
}

// Assertion (throws if invalid)
assertUsageSummary(data);
// data is now typed as UsageSummary

// Array validation
const items: unknown[] = await fetchItems();
const summaries = items.filter(isUsageSummary);
// summaries is UsageSummary[]
```

---

## API Reference

### `subscriptions.listUsageSummaries(subscriptionId, options?)`

List usage summaries for a subscription.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| subscriptionId | string | Yes | Subscription UUID |
| options.page | number | No | Page number (0-indexed) |
| options.size | number | No | Page size (1-200) |
| options.sort | string | No | Sort field |

Returns: `Promise<PagedResponse<UsageSummary>>`

### `usageSummaries.get(usageSummaryId)`

Get a single usage summary.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| usageSummaryId | string | Yes | Usage summary UUID |

Returns: `Promise<UsageSummary>`

### `usageSummaries.listLines(usageSummaryId, options)`

List usage lines for a usage summary.

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| usageSummaryId | string | Yes | Usage summary UUID |
| options.usageDate | string | **Yes** | ISO 8601 date (e.g., "2024-01-15") |
| options.page | number | No | Page number (0-indexed) |
| options.size | number | No | Page size (1-200) |
| options.sort | string | No | Sort field |

Returns: `Promise<PagedResponse<UsageLine>>`
